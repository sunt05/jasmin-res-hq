# Session: 2025-12-31 (JASMIN)

**Issue**: [[PER-393]] / [[PER-394]]

## Completed
- [x] Verified longitude fix from LOCAL works (Freetown 28.16°C ✓)
- [x] Identified xarray.sel/isel performance bottleneck (~140× slower than numpy)
- [x] Confirmed via GitHub issue #2227 that bypassing xarray is correct approach
- [x] Rewrote `extract_era5_batch.py` using netCDF4 + numpy direct indexing
- [x] Tested full 2020 extraction: **9.5 min** for 882 cities × 8784 timesteps
- [x] Validated output (Freetown: 26.8°C mean, 24.1-29.5°C range)
- [x] Fixed pyproject.toml deprecation warning (tool.uv.dev-dependencies → dependency-groups.dev)
- [x] Installed GitHub CLI (`~/.local/bin/gh`) - needs `gh auth login`

## Key Finding: xarray Overhead

| Method | 6 files | 1 year projection |
|--------|---------|-------------------|
| xarray.sel | ~19s | ~8 hours |
| netCDF4 + numpy | 0.14s | ~3.5 min |

From [pydata/xarray#2227](https://github.com/pydata/xarray/issues/2227): using `.values[]` with numpy indexing is documented as **13× faster** than `isel`.

## In Progress
- [ ] Full 2020-2023 extraction not yet run
- State: 2020 test output in `outputs/era5_test/` (882 files, ~100MB)

## For Next Session

Run full multi-year extraction with all variables:

```bash
uv run python 20251231-hw-er-pilot/scripts/extract_era5_batch.py \
    --years 2020-2023 \
    --variables 2t 2d 10u 10v \
    --output-dir outputs/era5
```

Estimated time: ~38-40 min for 4 years × 4 variables × 882 cities

To add more variables, update `VAR_MAP` in the script.

## Files Changed
- `20251231-hw-er-pilot/scripts/extract_era5_batch.py` - Rewrote with netCDF4+numpy (140× speedup)
- `20251231-hw-er-pilot/scripts/extract_era5_cities.py` - Minor fix (per-file processing)
- `pyproject.toml` - Fixed deprecation warning
- `outputs/era5_test/` - 882 city files for 2020 (not in git)
